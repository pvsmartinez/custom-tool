# Session Log — Cafezin

> Histórico de sessões de desenvolvimento. Manter em ordem cronológica, mais recente por último.

---

- **2026-02-22 (init)** — Project initialized. Repo created on GitHub. Core infrastructure (git, scripts, AGENT.md) in place.
- **2026-02-22 (brainstorm)** — Full capability & stack brainstorm. See `docs/brainstorm.md`.
- **2026-02-22 (decision)** — Stack decided: Tauri v2 + React/TypeScript. No backend. GitHub Copilot API as primary AI. Google Slides for presentations. Mobile = view + voice only.
- **2026-02-22 (phase1-scaffold)** — Phase 1 MVP scaffolded: Tauri v2 app in `app/`, CodeMirror 6 Markdown editor, GitHub Copilot API streaming integration, AI panel (⌘K), `.env` setup. Tauri FS plugin wired for open/save. WorkspacePicker, Sidebar, UpdateModal added.
- **2026-02-22 (file-tree)** — Sidebar replaced with recursive VS Code-style file tree. `buildFileTree()` added to workspace service. `FileTreeNode` type added. Root dirs auto-expand. File-type icons per extension. `Workspace.fileTree` added alongside `Workspace.files`.
- **2026-02-22 (model-picker)** — AI model picker overhauled. `fetchCopilotModels()` fetches live list from Copilot `/models`. Custom dropdown with tiered rate badges (free/standard/premium). `CopilotModelInfo` type + `FALLBACK_MODELS` added.
- **2026-02-22 (edit-preview)** — Edit/Preview toggle added to header. `getFileTypeInfo()` utility maps extension → kind/mode. `MarkdownPreview` (marked) and `PDFViewer` (Tauri asset://) components added. PDFs open directly in preview; MD defaults to edit.
- **2026-02-22 (code-review)** — Fixed 5 bugs: duplicate step comment in workspace.ts; stale Copilot API version headers in streamCopilotChat (was 1.85/0.11, now 1.97/0.24); `isPremium` inconsistency in FALLBACK_MODELS; dead `handleFilesChange`/`onFilesChange` prop removed; fragile `availableModels !== FALLBACK_MODELS` reference check replaced with `modelsLoadedRef`. AGENT.md fully rewritten.
- **2026-02-22 (grammarly-model-sync)** — Three Phase 1 gaps closed: (1) `@grammarly/editor-sdk` installed and wired into `Editor.tsx` (later removed — Grammarly desktop app hooks natively). (2) `WorkspaceConfig.preferredModel` now fully wired — AIPanel accepts `initialModel`/`onModelChange` props; App.tsx calls `saveWorkspaceConfig` on every model switch. (3) Git Sync button added to Sidebar footer — calls `invoke('git_sync')` with a timestamp commit message; shows idle/syncing/done/error states with colour feedback.
- **2026-02-22 (google-phase2)** — Phase 2 Google integration implemented: `google_oauth` Rust command (PKCE + local TCP redirect server + browser open via `tauri-plugin-opener`); `services/google.ts` (OAuth2 PKCE token exchange/refresh, Drive backup folder + upload/download, Slides generation from `## heading` outline via batchUpdate API); `GooglePanel.tsx` modal — connect/disconnect, Drive file list + restore, Slides generate + iframe embed preview. Sidebar `⊡ Google` button. Cargo adds `sha2`, `base64`, `rand`. `.env.example` updated with Desktop app OAuth setup steps.
- **2026-02-22 (tldraw-canvas)** — tldraw v4.4.0 canvas integrated. `CanvasEditor.tsx` wraps `<Tldraw>` with file-based persistence: snapshot serialised to JSON via `editor.getSnapshot()`, debounced 500 ms, saved to `.tldr.json` via existing auto-save path. `FileKind` extended with `'canvas'`; `.tldr.json` detected before generic JSON in `getFileTypeInfo()`. `createCanvasFile()` added to workspace service. Sidebar `+ New canvas` button added; `⊡ Google` button commented out (code kept). App.tsx wires canvas branch into render cascade; word count hidden for canvas files.
- **2026-02-22 (sidebar-creator)** — Sidebar file/folder creation overhauled. Three trigger points: EXPLORER header hover icons, directory row hover `+`, right-click context menu. Unified inline creator panel with type pills (MD/TS/TSX/JS/JSON/CSS/HTML/PY/SH/TXT) and a distinct `◈ Canvas` toggle button (creates `.tldr.json`). Canvas is visually separated from code/text types (gold colour, full-width button). `createFolder()` added to `workspace.ts`. All creation now supports nested paths + auto-creates missing parent dirs.
- **2026-02-22 (canvas-present)** — Canvas upgraded: tldraw Frames now act as slides. `▶ Present` button appears as a floating overlay; clicking it locks camera to frame 0 and hides tldraw share/help/minimap chrome. Keyboard: ←/→/Space navigates slides, Esc exits. Grid mode (`isGridMode: true`) enabled on mount for snap-to-grid design. `inferDarkMode` wired so tldraw matches app theme. `TLComponents` override defined as stable module constant.
- **2026-02-22 (canvas-figma)** — Canvas upgraded toward Figma/Miro/Slides UX. (1) **Slide strip**: horizontal scrollable panel at bottom of canvas (like Google Slides filmstrip / Figma pages panel). Shows all `frame` shapes as numbered cards. Click = zoom to. Double-click = present from that slide. `▼ Slides` toggle collapses/expands. Active slide highlighted in blue during presentation. (2) **`+ Slide` button**: creates a 1280×720 frame positioned to the right of the last one with a 80px gap; zooms camera to new slide. (3) **Export PNG**: `↓` button on each card calls `exportAs(editor, [frameId], { format: 'png', name })`. (4) **Figma-like zoom**: `cameraOptions={{ wheelBehavior: 'zoom' }}` — scroll wheel / trackpad now zooms instead of panning (same as Figma). (5) **Reactive frame sync**: `store.listen(syncFrames, { scope: 'document' })` keeps strip up-to-date as shapes change. `canvas-editor-main` wrapper added (flex:1) so strip has a fixed area below canvas. Layout is stable at any strip state.
- **2026-02-23 (canvas-ai-hardening)** — AI canvas reliability pass: (1) `MAX_ROUNDS` 6→50; exhaustion shows user-visible "continue" CTA. (2) `{"op":"clear"}` guarded — removed from normal op list in system prompt + marked DANGER in tool description. (3) `summarizeCanvas()` made hierarchical — builds `frameChildren` map, lists each slide's children under it. (4) `modelSupportsVision(id)` helper + `supportsVision` field on `CopilotModelInfo` — o-series models get no image inputs. (5) Before-screenshot injected as multipart user message on every canvas send (not a separate user message — avoids consecutive-user-messages 400). (6) Better API error messages: JSON `error.message` extracted before surfacing.
- **2026-02-23 (slide-strip-ux)** — Slide strip UX overhaul: drag-to-reorder (x-position swap), right-click context menu (Export PNG / Move Left / Move Right / Duplicate / Delete), format panel "Slide / ↓ Export PNG" section when frame selected, reduced card width 180→120px. Fixed `TLFrameShape` (not exported by tldraw v4 — use `AnyFrame` cast), `editor.batch()` (doesn't exist — use plain loop), `executeCanvasCommands` return type (destructure `{ count }`).
- **2026-02-23 (image-save-fix)** — Pexels image save button was silently doing nothing: root cause was native `fetch()` being blocked by Tauri HTTP allow-list (only `api.pexels.com` was listed, not `images.pexels.com`). Fixed: switched to `tauriFetch`, added `images.pexels.com/**` to `capabilities/default.json`.
- **2026-02-23 (ai-review-panel)** — `AIReviewPanel` was built but never mounted. Wired up: import + `showAIReview` state in App.tsx; both `onOpenAIReview` callbacks (Sidebar + WorkspaceHome) now open the panel; `onJumpToText` closes panel and jumps editor to passage.
- **2026-02-23 (context-summarization)** — Mid-run context summarization added to `runCopilotAgent`: `estimateTokens()` tracks approximate token usage per round (chars/4); when over `CONTEXT_TOKEN_LIMIT=90_000` the agent calls the model for a dense session summary, writes a full conversation snapshot (sans base64) to `cafezin/copilot-log.jsonl` as a new `archive` entry type, then rebuilds the context window to: system msgs + original task + `[SESSION SUMMARY]` + last 8 messages. Fallback blind round-pruning retained for sub-limit overage. `runCopilotAgent` now accepts `workspacePath?` and `sessionId?` params, threaded from AIPanel. `copilotLog.ts` extended with `CopilotArchiveEntry` interface + `appendArchiveEntry()`. AGENT.md updated with log format docs.
- **2026-02-23 (canvas-slide-sync)** — Slide strip ordering and theme system hardened. (1) Frame sort uses `.sort((a, b) => a.x - b.x)` in `syncFrames`, `addSlide`, `rescanFrames`, `enterPresent` — fixes reorder inconsistencies. (2) Camera-based active frame tracking in `handleMount` (store listener on viewport change). (3) `applyThemeToSlides()` extended to restyle shapes tagged `meta.textRole` (heading/body) — changes font/color/size when theme switches. (4) `insertTextPreset(variant)` creates a properly-themed text shape inside the current slide and immediately enters edit mode — replaces the old pen-style-only buttons. (5) Strip active highlight works outside presentation mode too.
- **2026-02-23 (canvas-theme-bg)** — Theme image background loading fixed end-to-end. Root causes: (a) `convertFileSrc` produces `asset://localhost/…` URLs which required `assetProtocol` plugin — now enabled in `tauri.conf.json` with `scope: ["$HOME/**"]`. (b) `asset://` paths don't persist across restarts. Fix: theme image picker reads the chosen file via `readFile` (imported from `@tauri-apps/plugin-fs`), converts to base64 data URL via `FileReader`, stores the self-contained data URL in `slideBgImage`. Active image label shows "Custom image" for data URLs instead of a garbage path.
- **2026-02-23 (canvas-slide-layouts)** — Slide layout system added to `CanvasEditor`. `applySlideLayout(editor, frame, layoutId, theme)` provides 6 presets: `blank`, `title-only`, `title-body`, `title-subtitle`, `two-column`, `image-right`. Shapes created by layouts are tagged `meta.textRole` so theme changes auto-restyle them. `CanvasTheme` interface gains `defaultLayout?: string`. Theme panel gains a 3×2 grid of layout buttons + Apply to Slide. New slides created via `addSlide` auto-populate using `defaultLayout` (default: `title-body`).
- **2026-02-23 (canvas-format-panel-v1)** — Format panel (`CanvasFormatPanel` in `CanvasEditor.tsx`) extended with professional tools: (1) Rotation — ±15° step buttons + direct number input. (2) Opacity — 0–100 slider. (3) Align & Distribute — 6 alignment operations (left/center/right/top/middle/bottom) for multi-select; 2 distribute ops (H/V). (4) Lock/Unlock — locks shapes and deselects them. (5) Corner radius — 0–50 slider, applied via `shape.meta.cornerRadius`, rendered in tldraw `shapeIndicators` override. (6) Shadow — `ShadowMeta` stored in `shape.meta.shadow`; 4 presets (none/soft/medium/hard) + individual sliders for blur/x/y/opacity; rendered via CSS drop-filter + custom SVG overlay on shape.
- **2026-02-23 (canvas-format-panel-v2)** — Five more format panel controls added matching Figma/Miro parity: (1) **Geo shape type picker** — `geoInfo` useValue detects when all selected shapes are non-bg geo; shows 10 common types in a 5-column grid (rect/ellipse/triangle/diamond/hex/star/cloud/heart/check-box/x-box) + expandable extra row of 10 (pentagon/octagon/arrows/rhombus variants); uses `(shape.props as any).geo` since `GeoShapeGeoStyle` is not exported from tldraw. (2) **W×H dimension inputs** — `sizeInfo` useValue for single geo/image shape; two number inputs for exact pixel dimensions. (3) **Layer order** — `canReorder` useValue; 4 buttons: ⤒ `.bringToFront()`, ↑ `.bringForward()`, ↓ `.sendBackward()`, ⤓ `.sendToBack()`. (4) **Group/Ungroup** — `canGroup` (2+ non-frame), `isGroup` (single group) useValues; `editor.groupShapes()` / `editor.ungroupShapes()`. (5) **Flip H/V** — `canFlip` useValue for geo/image shapes; `editor.flipShapes(ids, 'horizontal'|'vertical')`.
- **2026-02-23 (ai-error-recovery)** — `onError` callback in `handleSend` (AIPanel.tsx) now preserves already-streamed partial text on error. Previously it called `setLiveItems([])` immediately, silently discarding anything the model had already streamed. Fix: before clearing, commits the partial as a regular assistant message (same pattern as `handleStop` and the interrupt flow), then shows the error banner below it. No-op if nothing was streamed yet.
